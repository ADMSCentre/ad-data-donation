let pyScript,env={};function runCycle(e){console.log("[ProcessingWorker] runCycle "+JSON.stringify(e));try{scriptEvent=pyScript.send(e),self.postMessage({eventType:"runCycleDone",scriptEvent:scriptEvent.toJs({create_proxies:!1,dict_converter:Object.fromEntries})})}catch(o){self.postMessage({eventType:"runCycleDone",scriptEvent:generateErrorMessage(o.toString())})}}function unwrap(e){return console.log("[ProcessingWorker] unwrap response: "+JSON.stringify(e.payload)),new Promise((o=>{if("PayloadFile"===e.payload.__type__)copyFileToPyFS(e.payload.value,o);else o(e.payload)}))}function copyFileToPyFS(e,o){directoryName="/file-input",pathStats=self.pyodide.FS.analyzePath(directoryName),pathStats.exists?self.pyodide.FS.unmount(directoryName):self.pyodide.FS.mkdir(directoryName),self.pyodide.FS.mount(self.pyodide.FS.filesystems.WORKERFS,{files:[e]},directoryName),o({__type__:"PayloadString",value:directoryName+"/"+e.name})}function readFileFromPyFS(e,o){const n=self.pyodide.FS.readdir("/file-output");console.log("[ProcessingWorker] readFileFromPyFS: "+n)}function initialise(){return console.log("[ProcessingWorker] initialise"),startPyodide().then((e=>(self.pyodide=e,loadPackages()))).then((()=>installPortPackage())).then((()=>{console.log("[ProcessingWorker] creating file system"),self.pyodide.FS.mkdir("/file-output"),self.pyodide.FS.mount(self.pyodide.FS.filesystems.WORKERFS,{},"/file-output")}))}function startPyodide(){return importScripts("https://cdn.jsdelivr.net/pyodide/v0.24.0/full/pyodide.js"),console.log("[ProcessingWorker] loading Pyodide"),console.log("[ProcessingWorker] env: "+JSON.stringify(env)),loadPyodide({indexURL:"https://cdn.jsdelivr.net/pyodide/v0.24.0/full/",env:env})}function loadPackages(){return console.log("[ProcessingWorker] loading packages"),self.pyodide.loadPackage(["micropip","numpy","pandas","regex"])}function installPortPackage(){return console.log("[ProcessingWorker] load port package"),self.pyodide.runPythonAsync('\n    import micropip\n    await micropip.install("../../port-0.0.0-py3-none-any.whl", deps=False)\n    import port\n  ')}function generateErrorMessage(e){return{__type__:"CommandUIRender",page:{__type__:"PropsUIPageError",stacktrace:e}}}onmessage=e=>{const{eventType:o}=e.data;switch(o){case"initialise":env=e.data.env,initialise().then((()=>{self.postMessage({eventType:"initialiseDone"})}));break;case"firstRunCycle":pyScript=self.pyodide.runPython("port.start(".concat(e.data.sessionId,")")),runCycle(null);break;case"nextRunCycle":const{response:n}=e.data;unwrap(n).then((e=>{runCycle(e)}));break;case"readFile":readFileFromPyFS(e.data.filename,(o=>{self.postMessage({eventType:"readFileFromPyFSDone",filename:e.data.filename,file:o})}));break;default:console.log("[ProcessingWorker] Received unsupported event: ",o)}};